{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 118, "column": 0}, "map": {"version":3,"sources":["file:///E:/department-portal-2/lib/auth.ts"],"sourcesContent":["import { NextAuthOptions } from \"next-auth\"\r\nimport CredentialsProvider from \"next-auth/providers/credentials\"\r\nimport fs from \"fs\"\r\nimport path from \"path\"\r\n\r\ninterface StaffUser {\r\n    id: string\r\n    username: string\r\n    password: string\r\n    name: string\r\n    role: \"admin\" | \"hod\" | \"placement\" | \"faculty\"\r\n    department?: string\r\n    email?: string\r\n}\r\n\r\n// Helper to read staff users from JSON file\r\nfunction readStaffUsers(): StaffUser[] {\r\n    try {\r\n        const filePath = path.join(process.cwd(), \"public\", \"staff-users.json\")\r\n        if (!fs.existsSync(filePath)) {\r\n            return []\r\n        }\r\n        const data = fs.readFileSync(filePath, \"utf-8\")\r\n        return JSON.parse(data)\r\n    } catch (error) {\r\n        console.error(\"Error reading staff users:\", error)\r\n        return []\r\n    }\r\n}\r\n\r\nfunction logDebug(message: string, data?: any) {\r\n    try {\r\n        const logPath = path.join(process.cwd(), 'auth-debug.log');\r\n        const timestamp = new Date().toISOString();\r\n        const start = `\\n[${timestamp}] ${message}\\n`;\r\n        const payload = data ? JSON.stringify(data, null, 2) + '\\n' : '';\r\n        fs.appendFileSync(logPath, start + payload);\r\n    } catch (e) {\r\n        console.error(\"Failed to write to debug log\", e);\r\n    }\r\n}\r\n\r\nexport const authOptions: NextAuthOptions = {\r\n    providers: [\r\n        CredentialsProvider({\r\n            name: \"Credentials\",\r\n            credentials: {\r\n                email: { label: \"Email\", type: \"text\", placeholder: \"hod@example.com\" },\r\n                password: { label: \"Password\", type: \"password\" }\r\n            },\r\n            async authorize(credentials) {\r\n                console.log(\"[NextAuth] Authorize called with:\", credentials)\r\n                logDebug(\"Authorize called\", { email: credentials?.email });\r\n\r\n                if (!credentials?.email || !credentials?.password) {\r\n                    logDebug(\"Missing credentials\");\r\n                    return null\r\n                }\r\n\r\n                try {\r\n                    const apiUrl = `${process.env.NEXT_PUBLIC_API_URL}/auth/login`;\r\n                    logDebug(`Fetching ${apiUrl}`);\r\n\r\n                    const response = await fetch(apiUrl, {\r\n                        method: 'POST',\r\n                        headers: { 'Content-Type': 'application/json' },\r\n                        body: JSON.stringify({\r\n                            email: credentials.email,\r\n                            password: credentials.password\r\n                        })\r\n                    });\r\n\r\n                    logDebug(\"Response status\", response.status);\r\n\r\n                    const data = await response.json();\r\n\r\n                    if (response.ok && data.user) {\r\n                        console.log(`[NextAuth] Success: Authenticated as ${data.user.role}`);\r\n                        logDebug(\"Login Success\", { role: data.user.role });\r\n                        return {\r\n                            id: data.user.id,\r\n                            name: data.user.name,\r\n                            email: data.user.email,\r\n                            role: data.user.role.toLowerCase(), // Frontend expects lowercase\r\n                            department: data.user.department,\r\n                            accessToken: data.accessToken,\r\n                            rollNumber: data.user.rollNumber // Add roll number if present\r\n                        };\r\n                    }\r\n\r\n                    console.log(\"[NextAuth] Authentication failed:\", data.error || \"Unknown error\");\r\n                    logDebug(\"Authentication failed\", data);\r\n                    return null;\r\n                } catch (error: any) {\r\n                    console.error(\"[NextAuth] Login request error:\", error);\r\n                    logDebug(\"Login Request Error\", { message: error.message, stack: error.stack });\r\n                    return null;\r\n                }\r\n            }\r\n        })\r\n    ],\r\n    callbacks: {\r\n        async jwt({ token, user }: { token: any, user: any }) {\r\n            if (user) {\r\n                token.id = user.id\r\n                token.role = user.role\r\n                token.department = user.department\r\n                token.accessToken = user.accessToken\r\n                token.rollNumber = user.rollNumber // For students\r\n            }\r\n            return token\r\n        },\r\n        async session({ session, token }: { session: any, token: any }) {\r\n            if (session.user) {\r\n                // Ensure ID is passed to session. User id is often in 'sub' of token by default, but we use explicit 'id'\r\n                session.user.id = token.id || token.sub\r\n                session.user.role = token.role\r\n                session.user.department = token.department\r\n                session.accessToken = token.accessToken\r\n                session.user.rollNumber = token.rollNumber // Pass roll number\r\n            }\r\n            return session\r\n        }\r\n    },\r\n    pages: {\r\n        signIn: '/login',\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 252, "column": 0}, "map": {"version":3,"sources":["file:///E:/department-portal-2/app/api/users/route.ts"],"sourcesContent":["import { NextRequest, NextResponse } from \"next/server\"\r\nimport { getServerSession } from \"next-auth\"\r\nimport { authOptions } from \"@/lib/auth\"\r\nimport fs from \"fs\"\r\nimport path from \"path\"\r\n\r\nfunction logDebug(message: string, data?: any) {\r\n    try {\r\n        const logPath = path.join(process.cwd(), 'proxy-debug.log');\r\n        const timestamp = new Date().toISOString();\r\n        const start = `\\n[${timestamp}] ${message}\\n`;\r\n        const payload = data ? JSON.stringify(data, null, 2) + '\\n' : '';\r\n        fs.appendFileSync(logPath, start + payload);\r\n    } catch (e) {\r\n        console.error(\"Failed to write to debug log\", e);\r\n    }\r\n}\r\n\r\nconst API_URL = process.env.NEXT_PUBLIC_API_URL || \"http://localhost:5000/api/v1\"\r\n\r\n// Helper to get auth header\r\nasync function getAuthHeader() {\r\n    const session = await getServerSession(authOptions)\r\n    const token = (session as any)?.accessToken\r\n    if (!token) return null\r\n    return {\r\n        \"Authorization\": `Bearer ${token}`,\r\n        \"Content-Type\": \"application/json\"\r\n    }\r\n}\r\n\r\n// GET - Fetch all users\r\nexport async function GET() {\r\n    try {\r\n        const headers = await getAuthHeader()\r\n        if (!headers) {\r\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n        }\r\n\r\n        const response = await fetch(`${API_URL}/users`, { headers })\r\n\r\n        if (!response.ok) {\r\n            // Pass through backend error status\r\n            const errorData = await response.json().catch(() => ({}))\r\n            return NextResponse.json(errorData, { status: response.status })\r\n        }\r\n\r\n        const data = await response.json()\r\n        return NextResponse.json(data)\r\n    } catch (error) {\r\n        console.error(\"Error fetching users:\", error)\r\n        return NextResponse.json({ error: \"Failed to fetch users\" }, { status: 500 })\r\n    }\r\n}\r\n\r\n// POST - Add a new user\r\nexport async function POST(request: NextRequest) {\r\n    logDebug(\"[POST] User creation request received\");\r\n    try {\r\n        logDebug(\"[POST] Getting session\");\r\n        const headers = await getAuthHeader()\r\n        logDebug(\"[POST] Headers obtained\", headers ? \"yes\" : \"no\");\r\n\r\n        if (!headers) {\r\n            logDebug(\"[POST] Unauthorized - No headers\");\r\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n        }\r\n\r\n        const body = await request.json()\r\n\r\n        logDebug(\"[Proxy] Creating user:\", body.username)\r\n\r\n        const response = await fetch(`${API_URL}/users`, {\r\n            method: \"POST\",\r\n            headers,\r\n            body: JSON.stringify(body)\r\n        })\r\n\r\n        logDebug(\"[Proxy] Backend response status:\", response.status);\r\n\r\n        const data = await response.json()\r\n        logDebug(\"[Proxy] Backend data:\", data);\r\n\r\n        if (!response.ok) {\r\n            console.log(\"[Proxy] Backend error:\", data)\r\n            return NextResponse.json(data, { status: response.status })\r\n        }\r\n\r\n        return NextResponse.json(data, { status: 201 })\r\n    } catch (error: any) {\r\n        console.error(\"Error adding user:\", error)\r\n        logDebug(\"[Proxy] Exception\", { message: error.message, stack: error.stack });\r\n        return NextResponse.json({ error: \"Failed to add user: \" + error.message }, { status: 500 })\r\n    }\r\n}\r\n\r\n// DELETE - Remove a user\r\nexport async function DELETE(request: NextRequest) {\r\n    try {\r\n        const headers = await getAuthHeader()\r\n        if (!headers) {\r\n            return NextResponse.json({ error: \"Unauthorized\" }, { status: 401 })\r\n        }\r\n\r\n        const { searchParams } = new URL(request.url)\r\n        const id = searchParams.get(\"id\")\r\n\r\n        if (!id) {\r\n            return NextResponse.json({ error: \"User ID required\" }, { status: 400 })\r\n        }\r\n\r\n        const response = await fetch(`${API_URL}/users/${id}`, {\r\n            method: \"DELETE\",\r\n            headers\r\n        })\r\n\r\n        if (!response.ok) {\r\n            const errorData = await response.json().catch(() => ({}))\r\n            return NextResponse.json(errorData, { status: response.status })\r\n        }\r\n\r\n        return NextResponse.json({ success: true })\r\n    } catch (error) {\r\n        console.error(\"Error deleting user:\", error)\r\n        return NextResponse.json({ error: \"Failed to delete user\" }, { status: 500 })\r\n    }\r\n}\r\n"],"names":[],"mappings":"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"}}]
}